# Chapter 3. Known Revisions

Classic Paxos只用于对单个值达成分布式共识，本章介绍多个被广泛使用的**Class Paxos衍生算法**

## Negative Responses, NACKs

在Classic Paxos算法中，当proposer请求的epoch比acceptor的要小的时，即$e < e_{pro}$，acceptor选择不回复任何消息任由proposer超时重试，遵循*If you can't say something nice, don't say nothing at all*原则

在实际实现中，通过**拒绝响应Negative Responses**来提升算法的性能，而不是每次都需要proposer超时，**当不满足epoch要求时acceptor可以返回$no\_promise(e)$和$no\_accept(e)$从而加快proposer的执行**

进一步，acceptor可以通过在拒绝响应中添加自身的额外信息来使得proposer能够更快感知到集群状态，例如$no\_promise(e,f,g,v)$和$no\_accept(e,f,g,v)$

- $e$：被拒绝的请求所携带的epoch
- $f$：acceptor自身更大的last promised epoch，即$e_{pro}$
- $(g,v)$：acceptor的last accepted proposals，例如在Raft算法中节点拒绝响应时会携带current term

当proposer收到：

- $no\_promise(e,f)$：立即重新开始Phase I并选择新的epoch满足$e > f$
- $no\_accept(e,f)$：立即重新开始Phase I并选择新的epoch满足$e > f$

[Raft中节点收到任意term更高消息时就会自动转为Follower](https://github.com/JasonYuchen/notes/blob/master/raft/03.Basic_Raft_Algorithm.md#4-%E9%80%89%E4%B8%BE%E4%B8%BB%E8%8A%82%E7%82%B9-leader-election)

## Bypassing Phase II

**若proposer在Phase I结束后已经发现majority acceptors都已经确定了某个值**，即收到了majority都回复了相同已接受提案的$(f,v)$的响应$promise(e,f,v)$，则按Classic Paxos算法该proposer应该带上该提案$(f,v)$并继续Phase II，但是显然这一个步骤是多余的，**proposer可以直接响应客户端已提交的值$v$，回避不必要的Phase II**

proposer在Phase I收到回复后的状态处于：

- **Decision not reached**：没有收到任何proposal，从而没有决定任何值，proposer可以采用自己的值并开始Phase II
- **Decision reached**：所有收到的$promise(e,f,v)$均持有相同的$(f,v)$且数量达到majority，此时proposer已经感知到达成共识的值并不需要再执行Phase II
- **Uncertainty**：收到部分proposal，此时proposer无法判断是否达成共识，需要采用拥有最大epoch即$e_{max}$提案的值并执行Phase II

[Raft中日志复制时，只要收到majority响应就认为提交，并不需要等待majority的commit index](https://github.com/JasonYuchen/notes/blob/master/raft/03.Basic_Raft_Algorithm.md#5-%E6%97%A5%E5%BF%97%E5%A4%8D%E5%88%B6-log-replication)

## Termination

proposer始终需要与majority沟通从而提交值或者感知已经被选择的值，从而对于一无所知的proposer而言系统也必须存活majority acceptors才能使得该proposer感知到被选择的值

在Classic Paxos中**引入Phase III，使acceptor能够感知到达成共识的值**，Classic Paxos中每个acceptor仅仅独立运行并响应proposer的请求，在Phase III中**proposer一旦感知到被选择的值后，在响应客户端的同时就主动发送$decide(v)$给所有acceptors**，从而每个acceptor确认$v = v_{dec}$已经达成共识，此后即使只存活了一个acceptor都可以告知所有proposer已经被选中的值$v_{dec}$

[Raft中所有节点会持有commit index来记录达成共识的位置，但并不会持久化且不违背安全性](https://github.com/JasonYuchen/notes/blob/master/raft/03.Basic_Raft_Algorithm.md#8-%E6%8C%81%E4%B9%85%E5%8C%96%E7%8A%B6%E6%80%81%E5%92%8C%E9%87%8D%E5%90%AF-persisted-state-and-server-restarts)

## Distinguished Proposer

## Phase Ordering

## Multi-Paxos

## Roles

## Epochs

## Phase I Voting for Epochs

## Proposal Copying

## Generalization to Quorums

## Miscellaneous
