# Chapter 11. Coordination Algorithms

## 11.1 Introduction

## 11.2 Leader Election

**互斥问题mutual exclusion**在形式上与**主节点选举leader election**有一定相似性，例如首个进入临界区critical section的节点可以被认为就是主节点，但是他们本质上不同且有不同的范式：

1. 互斥问题通常不考虑节点宕机，而主节点选举需要考虑主节点宕机后在非故障节点中选举
2. 互斥问题需要解决饥饿，而选举主节点并不要考虑饥饿，节点不需要轮流被选为主节点
3. 与互斥问题中节点离开临界区不同，被选举出来的主节点并不一定需要下台

### 11.2.1 Bully Algorithm

Bully算法假定网络是全相连的，并且信道不会出现故障而只有节点会宕机，当主节点宕机后，**未故障进程中带有最大ID的节点会最终成为新的主节点**，其流程如下：

1. 所有进程都会检测主节点的存活情况（通过心跳与超时机制），当认为主节点宕机时就会发送`election`消息给ID比自身更高的进程
2. 某个发出`election`消息的进程若收到了来自更高ID进程的`reply`消息，则立即放弃成为主节点，并且等待其他节点发送`leader`消息
3. 若在一定时间内，某个节点发出的`election`消息得不到任何响应，则自身选举成为主节点，并广播`leader`消息给所有节点
4. 若在一定时间内，收到`reply`进入等待的节点始终没有收到`leader`消息，则重启选举过程

显然这个算法的正确性是容易验证的，假定某个节点发出`election`消息，且其收到回复，则不会发送`leader`消息，因此不会有节点认为该节点是主节点；假如其未收到回复，则在ID高于该节点的所有进程里都已经认可其作为主节点，随后发出`leader`消息后所有节点都认为其是主节点；若有超时就发起新的选举，因此最终一定是未故障的最大ID节点成为主节点，注意**该算法假定信道可靠**

### 11.2.2 Maxima Finding on a Ring

假定忽略错误和故障检测，则主节点选举就退化成了找到一个带有UID的节点并形成共识，Bully算法假定网络结构是全相连的，其他一些算法则假定一个环状网络结构：

`TODO`

- Chang-Roberts Algorithm
- Fraklin's Algorithm
- Peterson's Algorithm

### 11.2.3 Election in Arbitrary Networks

采用**洪范的方式flooding**可以在任意拓扑结构的网络中进行主节点选举，假定算法按逻辑步骤执行，则需要`D`轮过程来完成选主，`D`就是网络的直径，其流程如下：

1. 初始时每个节点都认为主节点是自身，即`L(i) = i`，并且将该信息发送给所有邻接点
2. 每个节点在每次收到邻接点广播过来的消息时，选择更大的节点作为主节点，即`L(j) = max(L(j), L(i))`，并且将新的最大节点信息推送给所有邻接点
3. 假如按轮次执行，则在`D`轮后算法停止并可以选出拥有最大ID的正常节点作为主节点

若是完全异步网络，则该算法实际上就是利用了**gossip算法**

### 11.2.4 Election in Anonymous Networks

`TODO`

## 11.3 Synchronizers
