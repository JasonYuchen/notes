# Lecture 8. ZooKeeper

阅读材料笔记[ZooKeeper](ZooKeeper.md)

## 顺序的保证 Ordering Guarantees

- **线性一致性写 Linearizable writes**
    client将write发送给leader，leader确定顺序并分配`zxid`，随后发送给所有replicas，每个replica都根据leader确定的`zxid`顺序执行，与Raft提供的线性一致性相同
- **先到先得客户端顺序 FIFO client order**
    client对自己发起的read/write定义顺序
  - client-specified write order，提交的顺序即执行的顺序，因此client决定写的顺序
  - read在write order中的某一刻执行，并且read的执行点只会在write order中单调递增non-decreasing，从而也提供了**读己之写保证read-your-own-write**（提供`sync()`用线性一致性写提供read的屏障确保读到最新数据）
  - client需要**记录见到的最新的`zxid`**，从而在切换节点后依然不会读到较小`zxid`的数据
  - 如果client向leader提交了write请求对应一个`zxid`，在后续如果切换到另一个节点进行读取，则也必须读到比此前write的`zxid`更大的数据（此时可能需要等待leader将之前的write扩散到此节点)
- 例如：

    当write发生顺序时如下时，则只要read看到了ready，则一定能看到f1和f2：

    ```text
    Write order:        Read order:
    delete("ready")
    write f1
    write f2
    create("ready")
                        exists("ready")
                        read f1
                        read f2
    ```

    由于**watch机制的保证（避免polling）**，在read f2之前，write f1和f2就会引起watch通知reader，注意：**是在read f2的新数据前一定先被通知，依然可以read到旧f2数据**

    ```text
    Write order:        Read order:
                        exists("ready", watch=true)
                        read f1
    delete("ready")
    write f1
    write f2
                        read f2
    ```
